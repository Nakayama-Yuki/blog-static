# Nginxワーカープロセスを実行するユーザー（セキュリティのため非特権ユーザーを使用）
user nginx;
# ワーカープロセス数を自動設定（CPUコア数に基づいて最適化）
worker_processes auto;
# エラーログの出力先とログレベル（warn: 警告以上のメッセージを記録）
error_log /var/log/nginx/error.log warn;
# NginxのプロセスIDを保存するファイルのパス
pid /var/run/nginx.pid;

# イベント処理に関する設定
events {
    # 各ワーカープロセスが同時に処理できる接続数の上限
    worker_connections 1024;
    # Linuxでの効率的なイベント処理メソッド（epollを使用してパフォーマンス向上）
    use epoll;
    # 新しい接続を一度に複数受け入れる（パフォーマンス最適化）
    multi_accept on;
}

http {
    # MIMEタイプの定義ファイルを読み込み（ファイル拡張子と Content-Type の対応関係）
    include /etc/nginx/mime.types;
    # MIMEタイプが不明な場合のデフォルト設定（バイナリストリームとして扱う）
    default_type application/octet-stream;
    # アクセスログのフォーマット定義
    # IPアドレス、リクエスト情報、レスポンスステータス、キャッシュ状態などを記録
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for" '
                    'cache:$upstream_cache_status';

    # アクセスログの出力先とフォーマット指定
    access_log /var/log/nginx/access.log main;

    # パフォーマンス最適化のための基本設定
    # sendfile() システムコールを使用してファイル送信を高速化
    sendfile on;    
    # sendfile使用時にTCPパケットをまとめて送信（ネットワーク効率向上）
    tcp_nopush on;    
    # 小さいパケットを即座に送信（レスポンス速度向上）
    tcp_nodelay on;    
    # クライアント接続の保持時間（秒）
    keepalive_timeout 65;    
    # MIMEタイプハッシュテーブルの最大サイズ
    types_hash_max_size 2048;    
    # レスポンスヘッダーにNginxのバージョン情報を含めない（セキュリティ対策）
    server_tokens off;
    # gzip 圧縮設定（転送データ量を削減してページ読み込みを高速化）
    
    # gzip圧縮を有効化
    gzip on;    
    # レスポンスヘッダーに Vary: Accept-Encoding を追加（キャッシュの正確性を確保）
    gzip_vary on;    
    # プロキシ経由のリクエストも圧縮対象とする
    gzip_proxied any;    
    # 圧縮レベル（1-9、6は品質と速度のバランスが良い）
    gzip_comp_level 6;    
    # 圧縮対象とする最小ファイルサイズ（バイト、小さすぎるファイルは圧縮しない）
    gzip_min_length 256;
        
    # 圧縮対象のMIMEタイプを指定
    # text/html はデフォルトで含まれるため記載不要
    gzip_types
        application/atom+xml
        application/geo+json
        application/javascript
        application/json
        application/ld+json
        application/manifest+json
        application/rdf+xml
        application/rss+xml
        application/vnd.ms-fontobject
        application/wasm
        application/x-font-opentype
        application/x-font-truetype
        application/x-font-ttf
        application/x-javascript
        application/x-web-app-manifest+json
        application/xhtml+xml
        application/xml
        font/eot
        font/opentype
        font/otf
        font/ttf
        image/bmp
        image/svg+xml
        image/vnd.microsoft.icon
        image/x-icon
        text/cache-manifest
        text/calendar
        text/css
        text/javascript
        text/markdown
        text/plain
        text/xml;

    # プロキシキャッシュの設定（静的コンテンツをキャッシュしてパフォーマンス向上）
    proxy_cache_path /var/cache/nginx
        levels=1:2                    # キャッシュディレクトリの階層構造（1階層目1文字、2階層目2文字）
        keys_zone=static_cache:10m    # キャッシュキーを保存する共有メモリ領域の名前とサイズ
        max_size=100m                 # キャッシュの最大サイズ（100MB）
        inactive=60d                  # 60日間アクセスがない場合、キャッシュを削除
        use_temp_path=off;            # 一時ファイルを直接キャッシュディレクトリに書き込む（パフォーマンス向上）

    # 仮想ホスト設定ファイルを読み込み（サイト固有の設定は別ファイルで管理）
    include /etc/nginx/conf.d/*.conf;
}
